<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Limn configurator</title>
  <link rel="stylesheet" href="engine.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@3.36.1/dist/tabler-icons.min.css">
  <style>
    .configurator {
      max-width: 480px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    .configurator h1 {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }
    .configurator .subtitle {
      color: var(--color-text-muted);
      font-size: 0.9rem;
      margin-bottom: 24px;
    }
    .configurator label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--color-text);
    }
    .configurator input, .configurator select, .configurator textarea {
      width: 100%;
      padding: 10px 12px;
      font-size: 0.95rem;
      background: var(--color-surface);
      color: var(--color-text);
      border: 1px solid var(--color-border);
      border-radius: 6px;
      margin-bottom: 16px;
    }
    .configurator input:focus, .configurator select:focus, .configurator textarea:focus {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }
    .configurator .links-section,
    .configurator .headings-section,
    .configurator .tiles-section {
      margin-bottom: 16px;
    }
    .configurator .tiles-section > label {
      margin-bottom: 4px;
    }
    .configurator .add-tile-wrap {
      position: relative;
      margin-top: 12px;
    }
    .configurator .add-tile-btn-main {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      background: var(--color-accent);
      color: var(--color-accent-text);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s;
    }
    .configurator .add-tile-btn-main:hover {
      opacity: 0.92;
    }
    .configurator .add-tile-btn-main:active {
      transform: scale(0.98);
    }
    .configurator .add-tile-btn-main .ti {
      font-size: 1rem;
    }
    .configurator .add-tile-btn-main .add-tile-chevron {
      font-size: 0.9rem;
      opacity: 0.85;
      margin-left: 2px;
      transition: transform 0.2s;
    }
    .configurator .add-tile-wrap.open .add-tile-chevron {
      transform: rotate(180deg);
    }
    .configurator .add-tile-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 6px;
      min-width: 200px;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      padding: 6px;
      z-index: 100;
      display: none;
    }
    .configurator .add-tile-dropdown.open {
      display: block;
    }
    .configurator .add-tile-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--color-text);
      font-size: 0.9rem;
      cursor: pointer;
      width: 100%;
      text-align: left;
      transition: background 0.12s;
    }
    .configurator .add-tile-option:hover {
      background: color-mix(in srgb, var(--color-accent) 18%, transparent);
    }
    .configurator .add-tile-option .ti {
      font-size: 1.1rem;
      color: var(--color-text-muted);
      flex-shrink: 0;
    }
    .configurator .tile-block {
      margin-bottom: 12px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      overflow: hidden;
      background: var(--color-surface);
    }
    .configurator .tile-block-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: color-mix(in srgb, var(--color-border) 30%, transparent);
      border-bottom: 1px solid var(--color-border);
    }
    .configurator .tile-block-type {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--color-text-muted);
      text-transform: uppercase;
    }
    .configurator .tile-block-actions {
      margin-left: auto;
      display: flex;
      gap: 4px;
    }
    .configurator .tile-block-actions button {
      width: 28px;
      height: 28px;
      padding: 0;
      min-width: 28px;
    }
    .configurator .tile-block-actions button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .configurator .tile-block-body {
      padding: 12px;
    }
    .configurator .links-hint {
      font-size: 0.85rem;
      color: var(--color-text-muted);
      margin: -4px 0 12px 0;
    }
    .configurator .link-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 12px;
      margin-bottom: 10px;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 8px;
    }
    .configurator .link-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .configurator .link-row-header .link-num {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .configurator .link-row-header .remove-link {
      padding: 6px 10px;
      min-width: 36px;
    }
    .configurator .link-row .link-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .configurator .link-row .link-field label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--color-text-muted);
      margin-bottom: 0;
    }
    .configurator .link-row .link-field .hint {
      font-size: 0.75rem;
      color: var(--color-text-muted);
      margin-top: -2px;
    }
    .configurator .link-row .link-field input {
      margin-bottom: 0;
    }
    .configurator .tile-block-body .links-section {
      margin-bottom: 0;
    }
    .configurator .tile-block-body .link-row {
      margin-bottom: 8px;
    }
    .configurator .tile-block-body .link-row:last-child {
      margin-bottom: 0;
    }
    .configurator .tile-block-body .heading-input,
    .configurator .tile-block-body .text-content {
      width: 100%;
      margin-bottom: 0;
      font-family: inherit;
    }
    .configurator .tile-field {
      margin-bottom: 12px;
    }
    .configurator .tile-field:last-child {
      margin-bottom: 0;
    }
    .configurator .tile-field label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--color-text-muted);
      margin-bottom: 4px;
    }
    .configurator .tile-field input,
    .configurator .tile-field select,
    .configurator .tile-field textarea {
      margin-bottom: 0;
      width: 100%;
    }
    .configurator .btn {
      padding: 10px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      background: var(--color-accent);
      color: var(--color-accent-text);
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .configurator .btn:hover {
      opacity: 0.9;
    }
    .configurator .btn-secondary {
      background: var(--color-surface);
      color: var(--color-text);
      border: 1px solid var(--color-border);
      padding: 8px 14px;
      font-size: 0.85rem;
    }
    .configurator .btn-secondary:hover {
      background: var(--color-border);
    }
    .configurator .add-link,
    .configurator .add-heading {
      margin-top: 8px;
      margin-bottom: 8px;
    }
    .configurator .download-section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--color-border);
    }
    .configurator .download-section p {
      font-size: 0.9rem;
      color: var(--color-text-muted);
      margin-bottom: 16px;
    }
    .configurator .back-link {
      display: inline-block;
      margin-bottom: 24px;
      font-size: 0.9rem;
      color: var(--color-text-muted);
      text-decoration: none;
    }
    .configurator .back-link:hover {
      color: var(--color-accent);
    }
    .configurator #status {
      font-size: 0.9rem;
      margin-top: 12px;
      min-height: 1.5em;
    }
    .configurator #status.loading {
      color: var(--color-accent);
    }
    .configurator #status.error {
      color: #ff6b6b;
    }

    /* Icon picker */
    .link-row-fields {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .link-row-fields .icon-picker-trigger {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      font-size: 18px;
    }
    .link-row-fields .link-field {
      flex: 1;
      min-width: 140px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .link-row-fields .link-field label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--color-text-muted);
      margin-bottom: 0;
    }
    .link-row-fields .link-field input {
      margin-bottom: 0;
    }
    .icon-picker-trigger {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 6px;
      color: var(--color-text-muted);
      cursor: pointer;
      font-size: 20px;
    }
    .icon-picker-trigger:hover {
      color: var(--color-accent);
      border-color: var(--color-accent);
    }
    .icon-picker-trigger:focus {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }
    .icon-picker-overlay {
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: transparent;
    }
    .icon-picker-popover {
      position: fixed;
      z-index: 1001;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 0;
      width: 320px;
      max-height: 360px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .icon-picker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid var(--color-border);
      flex-shrink: 0;
    }
    .icon-picker-header span {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--color-text-muted);
    }
    .icon-picker-close {
      width: 32px;
      height: 32px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--color-text-muted);
      cursor: pointer;
      font-size: 18px;
    }
    .icon-picker-close:hover {
      background: var(--color-border);
      color: var(--color-text);
    }
    .icon-picker-scroll {
      overflow-y: auto;
      padding: 12px;
    }
    .icon-picker-footer {
      padding: 8px 12px;
      border-top: 1px solid var(--color-border);
      font-size: 0.75rem;
      color: var(--color-text-muted);
      flex-shrink: 0;
    }
    .icon-picker-footer a {
      color: var(--color-accent);
      text-decoration: none;
    }
    .icon-picker-footer a:hover {
      text-decoration: underline;
    }
    .icon-picker-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 4px;
    }
    .icon-picker-btn {
      width: 40px;
      height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--color-text-muted);
      cursor: pointer;
      font-size: 20px;
    }
    .icon-picker-btn:hover {
      background: color-mix(in srgb, var(--color-accent) 20%, transparent);
      color: var(--color-accent);
    }
    .icon-picker-btn[data-selected="true"] {
      background: color-mix(in srgb, var(--color-accent) 25%, transparent);
      color: var(--color-accent);
    }
  </style>
</head>
<body>
  <div class="configurator">
    <a href="index.html" class="back-link">← Back to Limn</a>
    <h1>Limn configurator</h1>
    <p class="subtitle">Fill in your details, then download a ready-to-deploy zip.</p>

    <form id="form">
      <label for="name">Name</label>
      <input type="text" id="name" required placeholder="Your name">

      <label for="bio">Bio (optional)</label>
      <input type="text" id="bio" placeholder="A short line about you">

      <label for="theme">Theme</label>
      <select id="theme">
        <option value="dark">dark</option>
        <option value="scarlet">scarlet</option>
        <option value="light">light</option>
        <option value="nord">nord</option>
        <option value="dracula">dracula</option>
        <option value="catppuccin">catppuccin</option>
        <option value="gruvbox">gruvbox</option>
        <option value="solarized">solarized</option>
        <option value="retro">retro</option>
        <option value="monokai">monokai</option>
        <option value="pink-pony-club">pink-pony-club</option>
        <option value="mocha">mocha</option>
      </select>

      <div class="tiles-section">
        <label>Tiles</label>
        <p class="links-hint">Add and reorder tiles. Order here = order on your page.</p>
        <div id="tiles-stack"></div>
        <div class="add-tile-wrap">
          <button type="button" class="add-tile-btn-main" id="addTileBtn" aria-haspopup="true" aria-expanded="false">
            <i class="ti ti-plus"></i>
            Add tile
            <i class="ti ti-chevron-down add-tile-chevron"></i>
          </button>
          <div class="add-tile-dropdown" id="addTileDropdown" role="menu">
            <button type="button" class="add-tile-option" role="menuitem" data-type="heading"><i class="ti ti-heading"></i> Heading</button>
            <button type="button" class="add-tile-option" role="menuitem" data-type="text"><i class="ti ti-article"></i> Text</button>
            <button type="button" class="add-tile-option" role="menuitem" data-type="image"><i class="ti ti-photo"></i> Image</button>
            <button type="button" class="add-tile-option" role="menuitem" data-type="link"><i class="ti ti-link"></i> Link</button>
            <button type="button" class="add-tile-option" role="menuitem" data-type="linksbar"><i class="ti ti-apps"></i> Links bar</button>
            <button type="button" class="add-tile-option" role="menuitem" data-type="embed"><i class="ti ti-video"></i> Embed</button>
            <button type="button" class="add-tile-option" role="menuitem" data-type="calendar"><i class="ti ti-calendar"></i> Calendar</button>
          </div>
        </div>
      </div>

      <div class="download-section">
        <button type="submit" class="btn" id="downloadBtn">Download zip</button>
        <p id="status"></p>
      </div>
    </form>
  </div>

  <script type="module">
    const PICKER_ICONS = [
      "brand-github", "brand-instagram", "brand-x", "brand-linkedin", "brand-youtube",
      "brand-facebook", "brand-tiktok", "brand-discord", "brand-mastodon", "brand-bluesky",
      "brand-telegram", "brand-whatsapp", "brand-slack", "brand-spotify", "brand-twitch",
      "brand-reddit", "brand-pinterest", "brand-snapchat", "brand-apple", "brand-android",
      "brand-google", "brand-paypal", "brand-strava", "brand-soundcloud",
      "brand-vimeo", "brand-kickstarter", "brand-patreon", "brand-dribbble", "brand-behance",
      "brand-figma", "brand-framer", "brand-codepen", "brand-npm", "brand-css3",
      "brand-html5", "brand-javascript", "brand-python", "brand-react", "brand-vue",
      "mail", "mail-opened", "world", "link", "external-link", "rss",
      "heart", "star", "share",
      "calendar", "calendar-event", "map-pin", "map-pins", "phone", "phone-call",
      "message", "message-circle", "message-2", "send", "at", "home",
      "user", "users", "user-plus", "settings", "search", "bookmark",
      "tag", "camera", "photo", "file", "file-text", "folder", "download", "upload",
      "inbox", "bell", "gift", "coffee", "music", "video", "microphone",
      "pencil", "trash", "plus", "minus", "check", "x", "arrow-right", "arrow-left",
      "brand-amazon", "brand-medium"
    ];

    const ICON_ALIASES = {
      github: "brand-github", instagram: "brand-instagram", twitter: "brand-x", x: "brand-x",
      linkedin: "brand-linkedin", youtube: "brand-youtube", facebook: "brand-facebook",
      globe: "world", mail: "mail", link: "link"
    };

    function getTablerIconName(name) {
      if (!name) return "link";
      const n = name.trim().toLowerCase();
      return ICON_ALIASES[n] ?? n;
    }

    function updateIconTrigger(trigger) {
      const input = trigger.closest(".link-row-fields")?.querySelector(".link-icon");
      const i = trigger.querySelector("i");
      if (i && input) {
        const name = getTablerIconName(input.value);
        i.className = `ti ti-${name}`;
      }
    }

    function createIconPicker() {
      const overlay = document.createElement("div");
      overlay.className = "icon-picker-overlay";
      overlay.hidden = true;

      const popover = document.createElement("div");
      popover.className = "icon-picker-popover";

      const header = document.createElement("div");
      header.className = "icon-picker-header";
      header.innerHTML = `<span>Pick an icon</span><button type="button" class="icon-picker-close" title="Close" aria-label="Close"><i class="ti ti-x"></i></button>`;
      header.querySelector(".icon-picker-close").onclick = closePicker;

      const scroll = document.createElement("div");
      scroll.className = "icon-picker-scroll";

      const grid = document.createElement("div");
      grid.className = "icon-picker-grid";
      for (const icon of PICKER_ICONS) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "icon-picker-btn";
        btn.title = icon;
        btn.setAttribute("aria-label", icon);
        const i = document.createElement("i");
        i.className = `ti ti-${icon}`;
        btn.appendChild(i);
        btn.dataset.icon = icon;
        grid.appendChild(btn);
      }
      scroll.appendChild(grid);
      const footer = document.createElement("div");
      footer.className = "icon-picker-footer";
      footer.innerHTML = '6,000+ icons at <a href="https://tabler.io/icons" target="_blank" rel="noopener noreferrer">Tabler Icons</a> — use any icon name in your downloaded config.';
      popover.appendChild(header);
      popover.appendChild(scroll);
      popover.appendChild(footer);
      overlay.appendChild(popover);

      overlay.onclick = (e) => {
        if (e.target === overlay) closePicker();
      };

      grid.onclick = (e) => {
        const btn = e.target.closest(".icon-picker-btn");
        if (!btn) return;
        const icon = btn.dataset.icon;
        if (currentIconInput) {
          currentIconInput.value = icon;
          updateIconTrigger(currentIconInput.closest(".link-row-fields")?.querySelector(".icon-picker-trigger"));
        }
        closePicker();
      };

      document.body.appendChild(overlay);
      return { overlay, popover, grid };
    }

    function updatePickerPosition() {
      if (!picker || !currentIconInput || picker.overlay.hidden) return;
      const wrap = currentIconInput.closest(".link-row-fields");
      const trigger = wrap?.querySelector(".icon-picker-trigger");
      const rect = (trigger || currentIconInput).getBoundingClientRect();
      const popover = picker.popover;
      const popoverH = 360;
      const spaceBelow = window.innerHeight - rect.bottom;
      const spaceAbove = rect.top;
      const showBelow = spaceBelow >= popoverH || spaceBelow >= spaceAbove;
      popover.style.left = `${Math.min(Math.max(rect.left, 8), window.innerWidth - 328)}px`;
      popover.style.top = showBelow ? `${rect.bottom + 8}px` : "auto";
      popover.style.bottom = showBelow ? "auto" : `${window.innerHeight - rect.top + 8}px`;
    }

    let picker = null;
    let currentIconInput = null;

    function openPicker(input) {
      if (!picker) picker = createIconPicker();
      currentIconInput = input;
      picker.overlay.hidden = false;

      updatePickerPosition();

      const current = getTablerIconName(input.value);
      picker.grid.querySelectorAll(".icon-picker-btn").forEach(btn => {
        btn.dataset.selected = btn.dataset.icon === current ? "true" : "false";
      });

      const onKey = (e) => {
        if (e.key === "Escape") closePicker();
      };
      document.addEventListener("keydown", onKey);
      picker.overlay._escapeHandler = onKey;

      const onScrollOrResize = () => updatePickerPosition();
      window.addEventListener("scroll", onScrollOrResize, true);
      window.addEventListener("resize", onScrollOrResize);
      picker.overlay._scrollHandler = onScrollOrResize;
    }

    function closePicker() {
      if (picker) {
        picker.overlay.hidden = true;
        if (picker.overlay._escapeHandler) {
          document.removeEventListener("keydown", picker.overlay._escapeHandler);
          picker.overlay._escapeHandler = null;
        }
        if (picker.overlay._scrollHandler) {
          window.removeEventListener("scroll", picker.overlay._scrollHandler, true);
          window.removeEventListener("resize", picker.overlay._scrollHandler);
          picker.overlay._scrollHandler = null;
        }
      }
      currentIconInput = null;
    }

    const FILES = [
      "index.html", "engine.css", "engine.js", "themes.html",
      "README.md", "avatar.jpg", "example.ics",
      "tiles/base.css", "tiles/calendar.css", "tiles/calendar.js",
      "tiles/embed.css", "tiles/embed.js", "tiles/heading.css", "tiles/heading.js",
      "tiles/image.css", "tiles/image.js", "tiles/index.js", "tiles/icons.js", "tiles/link.css",
      "tiles/link.js", "tiles/linksbar.css", "tiles/linksbar.js",
      "tiles/text.css", "tiles/text.js", "tiles/tiles.css", "tiles/utils.js",
      "themes/catppuccin.yaml", "themes/dark.yaml", "themes/dracula.yaml",
      "themes/gruvbox.yaml", "themes/light.yaml", "themes/mocha.yaml",
      "themes/monokai.yaml", "themes/nord.yaml", "themes/pink-pony-club.yaml",
      "themes/retro.yaml", "themes/scarlet.yaml", "themes/solarized.yaml",
      "examples/calendar.yaml", "examples/embed.yaml", "examples/heading.yaml",
      "examples/image.yaml", "examples/link.yaml", "examples/linksbar.yaml",
      "examples/text.yaml"
    ];

    const baseUrl = location.href.replace(/configurator\.html.*$/, "");

    function escapeYaml(str) {
      if (!str) return "";
      if (/[:\#\*&\{\}\[\]\|>'"%@`\s]/.test(str)) return JSON.stringify(str);
      return str;
    }

    function buildConfig() {
      const name = document.getElementById("name").value.trim();
      const bio = document.getElementById("bio").value.trim();
      const theme = document.getElementById("theme").value;

      let tilesYaml = "";
      const blocks = document.querySelectorAll("#tiles-stack > .tile-block");
      for (const block of blocks) {
        const type = block.dataset.type;
        if (type === "heading") {
          const text = block.querySelector(".heading-input")?.value.trim();
          if (text) {
            tilesYaml += `  - type: heading
    text: ${escapeYaml(text)}
`;
          }
        } else if (type === "text") {
          const content = block.querySelector(".text-content")?.value.trim();
          if (content) {
            tilesYaml += `  - type: text
    content: ${escapeYaml(content)}
`;
          }
        } else if (type === "image") {
          const url = block.querySelector(".image-url")?.value.trim();
          const alt = block.querySelector(".image-alt")?.value.trim();
          if (url) {
            tilesYaml += `  - type: image
    url: ${escapeYaml(url)}
`;
            if (alt) tilesYaml += `    alt: ${escapeYaml(alt)}
`;
          }
        } else if (type === "link") {
          const url = block.querySelector(".link-tile-url")?.value.trim();
          const label = block.querySelector(".link-tile-label")?.value.trim();
          const icon = block.querySelector(".link-tile-icon")?.value.trim();
          if (url && label) {
            tilesYaml += `  - type: link
    url: ${escapeYaml(url)}
    label: ${escapeYaml(label)}
`;
            if (icon) tilesYaml += `    icon: ${icon}
`;
          }
        } else if (type === "linksbar") {
          const linkRows = block.querySelectorAll(".link-row");
          const items = [];
          for (const row of linkRows) {
            const label = row.querySelector(".link-label")?.value.trim();
            const url = row.querySelector(".link-url")?.value.trim();
            const icon = row.querySelector(".link-icon")?.value.trim();
            if (!url || !icon) continue;
            items.push({ icon, url, label: label || icon });
          }
          if (items.length > 0) {
            tilesYaml += `  - type: linksbar
    surface: hide
    items:
`;
            for (const item of items) {
              tilesYaml += `      - icon: ${item.icon}
        url: ${escapeYaml(item.url)}
        label: ${escapeYaml(item.label)}
`;
            }
          }
        } else if (type === "embed") {
          const html = block.querySelector(".embed-html")?.value.trim();
          const title = block.querySelector(".embed-title")?.value.trim();
          if (html) {
            tilesYaml += `  - type: embed
    html: ${escapeYaml(html)}
`;
            if (title) tilesYaml += `    title: ${escapeYaml(title)}
`;
          }
        } else if (type === "calendar") {
          const window = block.querySelector(".calendar-window")?.value;
          const src = block.querySelector(".calendar-src")?.value.trim();
          if (window && src) {
            tilesYaml += `  - type: calendar
    window: ${window}
    src: ${escapeYaml(src)}
`;
          }
        }
      }

      return `profile:
  name: ${escapeYaml(name)}
${bio ? `  bio: ${escapeYaml(bio)}\n` : ""}  image: avatar.jpg

theme: ${theme}

tiles:
` + tilesYaml;
    }

    function addLinkRow(container, label = "", url = "", icon = "link") {
      const n = container.querySelectorAll(".link-row").length + 1;
      const div = document.createElement("div");
      div.className = "link-row";
      div.innerHTML = `
        <div class="link-row-header">
          <span class="link-num">Icon ${n}</span>
          <button type="button" class="btn btn-secondary remove-link" title="Remove this icon">×</button>
        </div>
        <div class="link-row-fields">
          <button type="button" class="btn btn-secondary icon-picker-trigger" title="Pick icon" aria-label="Pick icon"><i class="ti ti-link"></i></button>
          <input type="hidden" class="link-icon" value="${(icon || "link").replace(/"/g, "&quot;")}">
          <div class="link-field">
            <label>Label</label>
            <input type="text" class="link-label" placeholder="e.g. GitHub, Email" value="${(label || "").replace(/"/g, "&quot;")}">
          </div>
          <div class="link-field">
            <label>URL</label>
            <input type="url" class="link-url" placeholder="https://..." value="${(url || "").replace(/"/g, "&quot;")}" required>
          </div>
        </div>
      `;
      div.querySelector(".remove-link").onclick = () => div.remove();
      const iconInput = div.querySelector(".link-icon");
      const trigger = div.querySelector(".icon-picker-trigger");
      updateIconTrigger(trigger);
      trigger.onclick = () => openPicker(iconInput);
      container.appendChild(div);
    }

    function createTileBlock(type, insertBefore = null) {
      const stack = document.getElementById("tiles-stack");
      const block = document.createElement("div");
      block.className = "tile-block";
      block.dataset.type = type;

      const typeLabels = { heading: "Heading", text: "Text", image: "Image", link: "Link", linksbar: "Links bar", embed: "Embed", calendar: "Calendar" };

      block.innerHTML = `
        <div class="tile-block-header">
          <span class="tile-block-type">${typeLabels[type]}</span>
          <div class="tile-block-actions">
            <button type="button" class="btn btn-secondary tile-move-up" title="Move up">↑</button>
            <button type="button" class="btn btn-secondary tile-move-down" title="Move down">↓</button>
            <button type="button" class="btn btn-secondary tile-remove" title="Remove">×</button>
          </div>
        </div>
        <div class="tile-block-body"></div>
      `;

      const body = block.querySelector(".tile-block-body");

      if (type === "heading") {
        body.innerHTML = `<input type="text" class="heading-input" placeholder="e.g. About, Links" style="margin-bottom:0">`;
        body.querySelector(".heading-input").value = "Links";
      } else if (type === "text") {
        body.innerHTML = `<textarea class="text-content" placeholder="Body copy, supports multiple lines..." rows="3" style="margin-bottom:0;resize:vertical;width:100%"></textarea>`;
        body.querySelector(".text-content").value = "Some body copy here.";
      } else if (type === "image") {
        body.innerHTML = `
          <div class="tile-field">
            <label>URL</label>
            <input type="text" class="image-url" placeholder="avatar.jpg or https://..." value="avatar.jpg">
          </div>
          <div class="tile-field">
            <label>Alt text (optional)</label>
            <input type="text" class="image-alt" placeholder="Description for screen readers">
          </div>
        `;
      } else if (type === "link") {
        body.innerHTML = `
          <div class="link-row-fields">
            <button type="button" class="btn btn-secondary icon-picker-trigger" title="Pick icon"><i class="ti ti-link"></i></button>
            <input type="hidden" class="link-icon link-tile-icon" value="brand-github">
            <div class="link-field">
              <label>Label</label>
              <input type="text" class="link-tile-label" placeholder="e.g. GitHub" value="">
            </div>
            <div class="link-field">
              <label>URL</label>
              <input type="url" class="link-tile-url" placeholder="https://..." value="">
            </div>
          </div>
        `;
        body.querySelector(".link-tile-label").value = "GitHub";
        body.querySelector(".link-tile-url").value = "https://github.com/yourname";
        const linkIconInput = body.querySelector(".link-tile-icon");
        const linkTrigger = body.querySelector(".icon-picker-trigger");
        updateIconTrigger(linkTrigger);
        linkTrigger.onclick = () => openPicker(linkIconInput);
      } else if (type === "linksbar") {
        const linksDiv = document.createElement("div");
        linksDiv.className = "links-section";
        body.appendChild(linksDiv);
        const addBtn = document.createElement("button");
        addBtn.type = "button";
        addBtn.className = "btn btn-secondary add-link";
        addBtn.textContent = "+ Add icon";
        addBtn.onclick = () => addLinkRow(linksDiv);
        body.appendChild(addBtn);
        addLinkRow(linksDiv, "GitHub", "https://github.com/yourname", "github");
        addLinkRow(linksDiv, "Email", "mailto:you@example.com", "mail");
      } else if (type === "embed") {
        body.innerHTML = `
          <div class="tile-field">
            <label>Title (optional)</label>
            <input type="text" class="embed-title" placeholder="e.g. Video">
          </div>
          <div class="tile-field">
            <label>Embed HTML</label>
            <textarea class="embed-html" placeholder="Paste iframe from Share → Embed..." rows="4" style="font-family:monospace;font-size:0.8rem"></textarea>
          </div>
        `;
      } else if (type === "calendar") {
        body.innerHTML = `
          <div class="tile-field">
            <label>Window</label>
            <select class="calendar-window">
              <option value="today">Today</option>
              <option value="week">Week</option>
              <option value="month" selected>Month</option>
              <option value="year">Year</option>
            </select>
          </div>
          <div class="tile-field">
            <label>URL (relative or absolute)</label>
            <input type="text" class="calendar-src" placeholder="example.ics or https://..." value="example.ics">
          </div>
        `;
      }

      function updateAllMoveButtons() {
        stack.querySelectorAll(".tile-block").forEach(b => {
          b.querySelector(".tile-move-up").disabled = !b.previousElementSibling;
          b.querySelector(".tile-move-down").disabled = !b.nextElementSibling;
        });
      }
      block.querySelector(".tile-move-up").onclick = () => {
        const prev = block.previousElementSibling;
        if (prev) {
          stack.insertBefore(block, prev);
          updateAllMoveButtons();
        }
      };
      block.querySelector(".tile-move-down").onclick = () => {
        const next = block.nextElementSibling;
        if (next) {
          stack.insertBefore(next, block);
          updateAllMoveButtons();
        }
      };
      block.querySelector(".tile-remove").onclick = () => {
        block.remove();
        updateAllMoveButtons();
      };

      if (insertBefore) {
        stack.insertBefore(block, insertBefore);
      } else {
        stack.appendChild(block);
      }
      updateAllMoveButtons();
    }

    (function initAddTileDropdown() {
      const wrap = document.querySelector(".add-tile-wrap");
      const btn = document.getElementById("addTileBtn");
      const dropdown = document.getElementById("addTileDropdown");
      function close() {
        dropdown.classList.remove("open");
        wrap.classList.remove("open");
        btn.setAttribute("aria-expanded", "false");
      }
      function open() {
        dropdown.classList.add("open");
        wrap.classList.add("open");
        btn.setAttribute("aria-expanded", "true");
      }
      btn.onclick = () => {
        if (dropdown.classList.contains("open")) close();
        else open();
      };
      dropdown.querySelectorAll(".add-tile-option").forEach(opt => {
        opt.onclick = () => {
          createTileBlock(opt.dataset.type);
          close();
        };
      });
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".add-tile-wrap")) close();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && dropdown.classList.contains("open")) close();
      });
    })();

    createTileBlock("linksbar");
    createTileBlock("heading");

    document.getElementById("form").onsubmit = async (e) => {
      e.preventDefault();
      const btn = document.getElementById("downloadBtn");
      const status = document.getElementById("status");
      btn.disabled = true;
      status.textContent = "Building zip…";
      status.className = "loading";

      try {
        const { default: JSZip } = await import("https://esm.sh/jszip@3.10.1");
        const zip = new JSZip();

        for (const file of FILES) {
          const res = await fetch(baseUrl + file);
          if (!res.ok) throw new Error(`Failed to fetch ${file}: ${res.status}`);
          const blob = await res.blob();
          zip.file(file, blob);
        }

        zip.file("config.yaml", buildConfig());

        const blob = await zip.generateAsync({ type: "blob" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "limn.zip";
        a.click();
        URL.revokeObjectURL(a.href);

        status.textContent = "Download started.";
        status.className = "";
      } catch (err) {
        status.textContent = err.message;
        status.className = "error";
      }
      btn.disabled = false;
    };
  </script>
</body>
</html>
