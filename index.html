<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Limn</title>
  <style>
    /* CSS custom property defaults — overridden by theme at runtime */
    :root {
      --color-bg:          #0f0f0f;
      --color-surface:     #1a1a1a;
      --color-text:        #f0f0f0;
      --color-text-muted:  #a0a0a0;
      --color-accent:      #7c6aff;
      --color-accent-text: #ffffff;
      --color-border:      #2e2e2e;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--color-bg);
      color: var(--color-text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
      min-height: 100vh;
    }

    #app {
      max-width: 640px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 24px 0 48px;
    }

    @media (min-width: 640px) {
      #app { padding: 40px 0 64px; gap: 14px; }
    }

    /* ---- Corner variants ---- */

    /* square */
    [data-corners="square"] .tile,
    [data-corners="square"] .tile-link a,
    [data-corners="square"] .error-box { border-radius: 0; }

    /* clipped — diagonal cut on top-right and bottom-left */
    [data-corners="clipped"] .tile,
    [data-corners="clipped"] .error-box {
      border: none;
      border-radius: 0;
      clip-path: polygon(0 0, calc(100% - 14px) 0, 100% 14px, 100% 100%, 14px 100%, 0 calc(100% - 14px));
    }
    [data-corners="clipped"] .tile-link a { border-radius: 0; }

    /* pixel — 3-step staircase corners (4px per step) + hard offset drop shadow */
    [data-corners="pixel"] .tile,
    [data-corners="pixel"] .error-box {
      border-radius: 0;
      border: none;
      /* Each corner is a 3-step staircase, going clockwise from top-left */
      clip-path: polygon(
        0 12px, 4px 12px, 4px 8px, 8px 8px, 8px 4px, 12px 4px, 12px 0,
        calc(100% - 12px) 0, calc(100% - 12px) 4px, calc(100% - 8px) 4px, calc(100% - 8px) 8px, calc(100% - 4px) 8px, calc(100% - 4px) 12px, 100% 12px,
        100% calc(100% - 12px), calc(100% - 4px) calc(100% - 12px), calc(100% - 4px) calc(100% - 8px), calc(100% - 8px) calc(100% - 8px), calc(100% - 8px) calc(100% - 4px), calc(100% - 12px) calc(100% - 4px), calc(100% - 12px) 100%,
        12px 100%, 12px calc(100% - 4px), 8px calc(100% - 4px), 8px calc(100% - 8px), 4px calc(100% - 8px), 4px calc(100% - 12px), 0 calc(100% - 12px)
      );
      /* drop-shadow renders after clip-path so it follows the staircase shape */
      filter: drop-shadow(4px 4px 0 var(--color-border));
    }
    [data-corners="pixel"] .tile-link a {
      border-radius: 0;
      transition: opacity 0.06s;
    }
    [data-corners="pixel"] .tile-heading {
      clip-path: none;
      filter: none;
    }

    /* ---- Loading / error ---- */

    #loading {
      text-align: center;
      padding: 64px 16px;
      color: var(--color-text-muted);
      font-size: 0.95rem;
    }

    .error-box {
      background: var(--color-surface);
      border: 1px solid #ff4444;
      border-radius: 6px;
      padding: 20px;
      color: #ff6b6b;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .error-box strong { display: block; margin-bottom: 6px; }

    /* ---- Profile header ---- */

    .profile {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 32px 16px 20px;
      text-align: center;
    }

    .profile-avatar,
    .profile-initials {
      width: 88px;
      height: 88px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .profile-avatar {
      object-fit: cover;
      background: var(--color-surface);
    }

    .profile-initials {
      background: var(--color-accent);
      color: var(--color-accent-text);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .profile-name {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--color-text);
      line-height: 1.2;
    }

    .profile-bio {
      font-size: 0.95rem;
      color: var(--color-text-muted);
      line-height: 1.5;
      max-width: 400px;
    }

    /* ---- Tile card base ---- */

    .tile {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 6px;
      overflow: hidden;
      padding: 16px;
    }

    /* ---- Heading tile ---- */

    .tile-heading h2 {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    /* ---- Text tile ---- */

    .tile-text p {
      font-size: 0.95rem;
      line-height: 1.65;
      color: var(--color-text-muted);
    }

    /* ---- Image tile ---- */

    .tile-image { padding: 0; }

    .tile-image img {
      width: 100%;
      display: block;
      aspect-ratio: 16 / 9;
      object-fit: cover;
    }

    /* ---- Link tile ---- */

    .tile-link { padding: 0; }

    .tile-link a {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 20px;
      background: var(--color-accent);
      color: var(--color-accent-text);
      text-decoration: none;
      font-size: 0.95rem;
      font-weight: 600;
      border-radius: 6px;
      transition: opacity 0.15s ease;
    }

    .tile-link a:hover,
    .tile-link a:focus-visible { opacity: 0.82; }

    .tile-link a:focus-visible { outline: 2px solid var(--color-accent-text); outline-offset: 2px; }

    .tile-link a svg { width: 18px; height: 18px; flex-shrink: 0; }

    /* ---- Embed tile ---- */

    .tile-embed { padding: 0; }

    .embed-label {
      padding: 12px 16px 8px;
      font-size: 0.82rem;
      font-weight: 500;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .embed-wrapper iframe {
      width: 100%;
      height: auto;
      aspect-ratio: 16 / 9;
      border: none;
      display: block;
    }

    /* ---- Calendar tile ---- */

    .tile-calendar { padding: 0; }

    .calendar-empty {
      color: var(--color-text-muted);
      font-size: 0.9rem;
      padding: 16px;
    }

    .calendar-item {
      display: flex;
      align-items: stretch;
    }

    .calendar-item + .calendar-item {
      border-top: 1px solid var(--color-border);
    }

    .calendar-item-date {
      background: var(--color-accent);
      color: var(--color-accent-text);
      width: 72px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 12px 8px;
      text-align: center;
      gap: 1px;
    }

    .calendar-date-day {
      font-size: 1.6rem;
      font-weight: 700;
      line-height: 1;
    }

    .calendar-date-month {
      font-size: 0.68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.85;
    }

    .calendar-date-time {
      font-size: 0.6rem;
      opacity: 0.75;
      margin-top: 3px;
      font-variant-numeric: tabular-nums;
      line-height: 1.4;
    }

    .calendar-item-details {
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      justify-content: center;
      min-width: 0;
    }

    .calendar-item-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--color-text);
    }

    .calendar-item-desc {
      font-size: 0.82rem;
      color: var(--color-text-muted);
      line-height: 1.4;
    }

    .calendar-item-location {
      font-size: 0.78rem;
      color: var(--color-text-muted);
      font-style: italic;
    }

    /* ---- Surface modifier ---- */

    .tile--surface-transparent {
      background: color-mix(in srgb, var(--color-surface) 50%, transparent);
      border-color: color-mix(in srgb, var(--color-border) 50%, transparent);
    }

    .tile--surface-hide {
      background: transparent;
      border-color: transparent;
    }

    /* ---- Linksbar tile ---- */

    .tile-linksbar {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 4px;
    }

    .tile-linksbar a {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      color: var(--color-text-muted);
      text-decoration: none;
      border-radius: 6px;
      transition: color 0.15s ease, background 0.15s ease;
    }

    .tile-linksbar a:hover,
    .tile-linksbar a:focus-visible {
      color: var(--color-accent);
      background: color-mix(in srgb, var(--color-accent) 12%, transparent);
    }

    .tile-linksbar a:focus-visible { outline: 2px solid var(--color-accent); outline-offset: 2px; }

    .tile-linksbar a svg { width: 22px; height: 22px; }
  </style>
</head>
<body>
  <div id="app">
    <div id="loading">Loading…</div>
  </div>

  <script type="module">
    import { load }      from "https://esm.sh/js-yaml@4";
    import ICAL          from "https://esm.sh/ical.js@2";
    import * as lucide   from "https://esm.sh/lucide";

    const { createIcons, ...icons } = lucide;

    // ---- Theme ----

    function applyTheme(theme) {
      const s = document.documentElement.style;
      s.setProperty("--color-bg",          theme.background);
      s.setProperty("--color-surface",     theme.surface);
      s.setProperty("--color-text",        theme.text);
      s.setProperty("--color-text-muted",  theme.textMuted  ?? "#888");
      s.setProperty("--color-accent",      theme.accent);
      s.setProperty("--color-accent-text", theme.accentText ?? "#fff");
      s.setProperty("--color-border",      theme.border     ?? "transparent");
      document.body.dataset.corners = theme.corners ?? "rounded";
    }

    // ---- Validation ----

    const KNOWN_TILE_TYPES = ["heading", "text", "image", "link", "embed", "calendar", "linksbar"];
    const CALENDAR_WINDOWS = ["today", "week", "month", "year"];

    function validate(config) {
      if (!config || typeof config !== "object") throw new Error("Config must be a YAML mapping");
      if (!config.profile)       throw new Error("Missing required field: profile");
      if (!config.profile.name)  throw new Error("Missing required field: profile.name");
      if (!config.theme)         throw new Error("Missing required field: theme");
      for (const k of ["background", "surface", "text", "accent"]) {
        if (!config.theme[k]) throw new Error(`Missing required theme field: theme.${k}`);
      }
      if (!Array.isArray(config.tiles)) throw new Error("tiles must be a list");
      config.tiles.forEach((tile, i) => {
        const at = `tiles[${i}]`;
        if (!tile.type)                            throw new Error(`${at} missing required field: type`);
        if (!KNOWN_TILE_TYPES.includes(tile.type)) throw new Error(`${at}.type "${tile.type}" is not a known tile type`);
        if (tile.type === "heading" && !tile.text)    throw new Error(`${at} (heading) missing required field: text`);
        if (tile.type === "text"    && !tile.content) throw new Error(`${at} (text) missing required field: content`);
        if (tile.type === "image"   && !tile.url)     throw new Error(`${at} (image) missing required field: url`);
        if (tile.type === "link") {
          if (!tile.url)   throw new Error(`${at} (link) missing required field: url`);
          if (!tile.label) throw new Error(`${at} (link) missing required field: label`);
        }
        if (tile.type === "embed" && !tile.html) throw new Error(`${at} (embed) missing required field: html`);
        if (tile.type === "linksbar") {
          if (!Array.isArray(tile.items) || tile.items.length === 0)
            throw new Error(`${at} (linksbar) requires at least one item in "items"`);
          tile.items.forEach((item, j) => {
            if (!item.icon) throw new Error(`${at}.items[${j}] (linksbar) missing required field: icon`);
            if (!item.url)  throw new Error(`${at}.items[${j}] (linksbar) missing required field: url`);
          });
        }
        if (tile.type === "calendar") {
          if (!tile.window) throw new Error(`${at} (calendar) missing required field: window`);
          if (!CALENDAR_WINDOWS.includes(tile.window))
            throw new Error(`${at} (calendar) window must be one of: ${CALENDAR_WINDOWS.join(", ")}`);

          if (!tile.src && !Array.isArray(tile.items))
            throw new Error(`${at} (calendar) requires either "src" (.ics file path) or "items" (list)`);
        }
      });
    }

    // ---- Error display ----

    function showError(err) {
      const box = document.createElement("div");
      box.className = "error-box";
      box.innerHTML = `<strong>Config error</strong>${err.message}`;
      const app = document.getElementById("app");
      app.innerHTML = "";
      app.appendChild(box);
    }

    // ---- Profile ----

    function renderProfile({ name, bio, image }) {
      const el = document.createElement("div");
      el.className = "profile";

      if (image) {
        const img = document.createElement("img");
        img.src = image;
        img.alt = name;
        img.className = "profile-avatar";
        img.onerror = () => img.replaceWith(makeInitials(name));
        el.appendChild(img);
      } else {
        el.appendChild(makeInitials(name));
      }

      const nameEl = document.createElement("div");
      nameEl.className = "profile-name";
      nameEl.textContent = name;
      el.appendChild(nameEl);

      if (bio) {
        const bioEl = document.createElement("p");
        bioEl.className = "profile-bio";
        bioEl.textContent = bio;
        el.appendChild(bioEl);
      }

      return el;
    }

    function makeInitials(name) {
      const div = document.createElement("div");
      div.className = "profile-initials";
      div.setAttribute("aria-hidden", "true");
      div.textContent = name.trim().split(/\s+/).map(w => w[0]).join("").slice(0, 2).toUpperCase();
      return div;
    }

    // ---- Tile helpers ----

    function makeTile(type) {
      const div = document.createElement("div");
      div.className = `tile tile-${type}`;
      return div;
    }

    // ---- Simplex tiles ----

    function renderHeadingTile({ text }) {
      const tile = makeTile("heading");
      const h2 = document.createElement("h2");
      h2.textContent = text;
      tile.appendChild(h2);
      return tile;
    }

    function renderTextTile({ content }) {
      const tile = makeTile("text");
      const p = document.createElement("p");
      p.textContent = content;
      tile.appendChild(p);
      return tile;
    }

    function renderImageTile({ url, alt }) {
      const tile = makeTile("image");
      const img = document.createElement("img");
      img.src = url;
      img.alt = alt ?? "";
      img.loading = "lazy";
      tile.appendChild(img);
      return tile;
    }

    // ---- Complex tiles ----

    function renderLinkTile({ icon, url, label }) {
      const tile = makeTile("link");
      const a = document.createElement("a");
      a.href = url;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      if (icon) {
        const i = document.createElement("i");
        i.setAttribute("data-lucide", icon);
        a.appendChild(i);
      }
      const span = document.createElement("span");
      span.textContent = label;
      a.appendChild(span);
      tile.appendChild(a);
      return tile;
    }

    function renderEmbedTile({ html, title }) {
      const tile = makeTile("embed");
      if (title) {
        const label = document.createElement("p");
        label.className = "embed-label";
        label.textContent = title;
        tile.appendChild(label);
      }
      const wrapper = document.createElement("div");
      wrapper.className = "embed-wrapper";
      wrapper.innerHTML = html;
      tile.appendChild(wrapper);
      return tile;
    }

    function renderIconsTile({ items }) {
      const tile = makeTile("linksbar");
      items.forEach(({ icon, url, label }) => {
        const a = document.createElement("a");
        a.href = url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        if (label) {
          a.title = label;
          a.setAttribute("aria-label", label);
        }
        const i = document.createElement("i");
        i.setAttribute("data-lucide", icon);
        a.appendChild(i);
        tile.appendChild(a);
      });
      return tile;
    }

    function filterAndSort(events, win) {
      const now = new Date();
      return events
        .filter(({ _start }) => {
          if (win === "today") return _start.toDateString() === now.toDateString();
          const days = win === "week" ? 7 : win === "month" ? 30 : 365;
          const cutoffMs = now.getTime() + days * 86_400_000;
          return _start >= now && _start.getTime() <= cutoffMs;
        })
        .sort((a, b) => a._start - b._start);
    }

    function populateCalendarTile(tile, events) {
      tile.innerHTML = "";
      if (events.length === 0) {
        const empty = document.createElement("p");
        empty.className = "calendar-empty";
        empty.textContent = "No upcoming events.";
        tile.appendChild(empty);
        return;
      }
      events.forEach(({ title, description, location, _start, _end, _allDay }) => {
        const item = document.createElement("div");
        item.className = "calendar-item";

        const dateCol = document.createElement("div");
        dateCol.className = "calendar-item-date";

        const dayEl = document.createElement("div");
        dayEl.className = "calendar-date-day";
        dayEl.textContent = _start.getDate();
        dateCol.appendChild(dayEl);

        const monthEl = document.createElement("div");
        monthEl.className = "calendar-date-month";
        monthEl.textContent = _start.toLocaleDateString(undefined, { month: "short" });
        dateCol.appendChild(monthEl);

        if (!_allDay) {
          const t1 = _start.toLocaleTimeString(undefined, { hour: "numeric", minute: "2-digit" });
          const t2 = _end.toLocaleTimeString(undefined,   { hour: "numeric", minute: "2-digit" });
          const timeEl = document.createElement("div");
          timeEl.className = "calendar-date-time";
          timeEl.textContent = `${t1}–${t2}`;
          dateCol.appendChild(timeEl);
        }

        item.appendChild(dateCol);

        const details = document.createElement("div");
        details.className = "calendar-item-details";

        const titleEl = document.createElement("div");
        titleEl.className = "calendar-item-title";
        titleEl.textContent = title;
        details.appendChild(titleEl);

        if (description) {
          const descEl = document.createElement("div");
          descEl.className = "calendar-item-desc";
          descEl.textContent = description;
          details.appendChild(descEl);
        }

        if (location) {
          const locEl = document.createElement("div");
          locEl.className = "calendar-item-location";
          locEl.textContent = location;
          details.appendChild(locEl);
        }

        item.appendChild(details);
        tile.appendChild(item);
      });
    }

    function parseIcs(icsText) {
      const comp = new ICAL.Component(ICAL.parse(icsText));
      return comp.getAllSubcomponents("vevent").map(vevent => {
        const ev = new ICAL.Event(vevent);
        return {
          title:       ev.summary     || "(No title)",
          description: ev.description || null,
          location:    ev.location    || null,
          _allDay:     ev.startDate.isDate,
          _start:      ev.startDate.toJSDate(),
          _end:        ev.endDate.toJSDate(),
        };
      });
    }

    function renderCalendarTile({ window: win, items, src }) {
      const tile = makeTile("calendar");

      if (src) {
        const loading = document.createElement("p");
        loading.className = "calendar-empty";
        loading.textContent = "Loading…";
        tile.appendChild(loading);

        fetch(src)
          .then(r => {
            if (!r.ok) throw new Error(`Could not load ${src} (HTTP ${r.status})`);
            return r.text();
          })
          .then(icsText => populateCalendarTile(tile, filterAndSort(parseIcs(icsText), win)))
          .catch(err => {
            tile.innerHTML = "";
            const errEl = document.createElement("p");
            errEl.className = "calendar-empty";
            errEl.textContent = `Calendar error: ${err.message}`;
            tile.appendChild(errEl);
          });
      } else {
        const events = (items ?? []).map(item => ({
          ...item,
          _allDay: !String(item.start).includes("T"),
          _start:  new Date(item.start),
          _end:    new Date(item.end),
        }));
        populateCalendarTile(tile, filterAndSort(events, win));
      }

      return tile;
    }

    // ---- Tile registry + dispatcher ----

    const tileRenderers = {
      heading:  renderHeadingTile,
      text:     renderTextTile,
      image:    renderImageTile,
      link:     renderLinkTile,
      embed:    renderEmbedTile,
      calendar: renderCalendarTile,
      linksbar: renderIconsTile,
    };

    function renderTile(tile) {
      const fn = tileRenderers[tile.type];
      if (!fn) throw new Error(`Unknown tile type: "${tile.type}"`);
      const el = fn(tile);
      if (tile.type !== "calendar") {
        const surface = tile.surface ?? (tile.type === "heading" ? "hide" : "show");
        if      (surface === "transparent") el.classList.add("tile--surface-transparent");
        else if (surface === "hide")        el.classList.add("tile--surface-hide");
      }
      document.getElementById("tiles").appendChild(el);
    }

    // ---- Bootstrap (top-level await) ----

    async function loadTheme(themeValue) {
      if (typeof themeValue === "string") {
        const path = `themes/${themeValue}.yaml`;
        const res = await fetch(path);
        if (!res.ok) throw new Error(`Could not load theme "${themeValue}" (${path} returned HTTP ${res.status})`);
        return load(await res.text());
      }
      return themeValue;
    }

    try {
      const r = await fetch("./config.yaml");
      if (!r.ok) throw new Error(`Could not load config.yaml (HTTP ${r.status})`);
      const config = load(await r.text());
      config.theme = await loadTheme(config.theme);
      validate(config);

      const app = document.getElementById("app");
      app.innerHTML = "";

      applyTheme(config.theme);
      app.appendChild(renderProfile(config.profile));

      const tilesEl = document.createElement("div");
      tilesEl.id = "tiles";
      tilesEl.style.display = "contents";
      app.appendChild(tilesEl);

      config.tiles.forEach(renderTile);
      createIcons({ icons });
    } catch (err) {
      showError(err);
    }
  </script>
</body>
</html>
