<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Limn configurator</title>
  <link rel="stylesheet" href="engine.css">
  <style>
    .configurator {
      max-width: 480px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    .configurator h1 {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }
    .configurator .subtitle {
      color: var(--color-text-muted);
      font-size: 0.9rem;
      margin-bottom: 24px;
    }
    .configurator label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--color-text);
    }
    .configurator input, .configurator select {
      width: 100%;
      padding: 10px 12px;
      font-size: 0.95rem;
      background: var(--color-surface);
      color: var(--color-text);
      border: 1px solid var(--color-border);
      border-radius: 6px;
      margin-bottom: 16px;
    }
    .configurator input:focus, .configurator select:focus {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }
    .configurator .link-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 8px;
      align-items: end;
      margin-bottom: 12px;
    }
    .configurator .link-row .link-url {
      grid-column: span 1;
    }
    @media (max-width: 480px) {
      .configurator .link-row {
        grid-template-columns: 1fr auto;
      }
      .configurator .link-row .link-icon {
        grid-column: 1;
      }
      .configurator .link-row .link-url {
        grid-column: 1;
      }
      .configurator .link-row .link-label {
        grid-column: 1;
      }
    }
    .configurator .link-row input {
      margin-bottom: 0;
    }
    .configurator .btn {
      padding: 10px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      background: var(--color-accent);
      color: var(--color-accent-text);
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .configurator .btn:hover {
      opacity: 0.9;
    }
    .configurator .btn-secondary {
      background: var(--color-surface);
      color: var(--color-text);
      border: 1px solid var(--color-border);
      padding: 8px 14px;
      font-size: 0.85rem;
    }
    .configurator .btn-secondary:hover {
      background: var(--color-border);
    }
    .configurator .add-link {
      margin-top: 8px;
    }
    .configurator .download-section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--color-border);
    }
    .configurator .download-section p {
      font-size: 0.9rem;
      color: var(--color-text-muted);
      margin-bottom: 16px;
    }
    .configurator .back-link {
      display: inline-block;
      margin-bottom: 24px;
      font-size: 0.9rem;
      color: var(--color-text-muted);
      text-decoration: none;
    }
    .configurator .back-link:hover {
      color: var(--color-accent);
    }
    .configurator #status {
      font-size: 0.9rem;
      margin-top: 12px;
      min-height: 1.5em;
    }
    .configurator #status.loading {
      color: var(--color-accent);
    }
    .configurator #status.error {
      color: #ff6b6b;
    }
  </style>
</head>
<body>
  <div class="configurator">
    <a href="index.html" class="back-link">← Back to Limn</a>
    <h1>Limn configurator</h1>
    <p class="subtitle">Fill in your details, then download a ready-to-deploy zip.</p>

    <form id="form">
      <label for="name">Name</label>
      <input type="text" id="name" required placeholder="Your name">

      <label for="bio">Bio (optional)</label>
      <input type="text" id="bio" placeholder="A short line about you">

      <label for="theme">Theme</label>
      <select id="theme">
        <option value="dark">dark</option>
        <option value="scarlet">scarlet</option>
        <option value="light">light</option>
        <option value="nord">nord</option>
        <option value="dracula">dracula</option>
        <option value="catppuccin">catppuccin</option>
        <option value="gruvbox">gruvbox</option>
        <option value="solarized">solarized</option>
        <option value="retro">retro</option>
        <option value="monokai">monokai</option>
        <option value="pink-pony-club">pink-pony-club</option>
        <option value="mocha">mocha</option>
      </select>

      <label>Links</label>
      <div id="links"></div>
      <button type="button" class="btn btn-secondary add-link" id="addLink">+ Add link</button>

      <div class="download-section">
        <button type="submit" class="btn" id="downloadBtn">Download zip</button>
        <p id="status"></p>
      </div>
    </form>
  </div>

  <script type="module">
    const FILES = [
      "index.html", "engine.css", "engine.js", "themes.html",
      "README.md", "avatar.jpg", "example.ics",
      "tiles/base.css", "tiles/calendar.css", "tiles/calendar.js",
      "tiles/embed.css", "tiles/embed.js", "tiles/heading.css", "tiles/heading.js",
      "tiles/image.css", "tiles/image.js", "tiles/index.js", "tiles/link.css",
      "tiles/link.js", "tiles/linksbar.css", "tiles/linksbar.js",
      "tiles/text.css", "tiles/text.js", "tiles/tiles.css", "tiles/utils.js",
      "themes/catppuccin.yaml", "themes/dark.yaml", "themes/dracula.yaml",
      "themes/gruvbox.yaml", "themes/light.yaml", "themes/mocha.yaml",
      "themes/monokai.yaml", "themes/nord.yaml", "themes/pink-pony-club.yaml",
      "themes/retro.yaml", "themes/scarlet.yaml", "themes/solarized.yaml",
      "examples/calendar.yaml", "examples/embed.yaml", "examples/heading.yaml",
      "examples/image.yaml", "examples/link.yaml", "examples/linksbar.yaml",
      "examples/text.yaml"
    ];

    const baseUrl = location.href.replace(/configurator\.html.*$/, "");

    function escapeYaml(str) {
      if (!str) return "";
      if (/[:\#\*&\{\}\[\]\|>'"%@`\s]/.test(str)) return JSON.stringify(str);
      return str;
    }

    function buildConfig() {
      const name = document.getElementById("name").value.trim();
      const bio = document.getElementById("bio").value.trim();
      const theme = document.getElementById("theme").value;

      const linkRows = document.querySelectorAll(".link-row");
      const linkTiles = [];
      for (const row of linkRows) {
        const label = row.querySelector(".link-label").value.trim();
        const url = row.querySelector(".link-url").value.trim();
        const icon = row.querySelector(".link-icon").value.trim();
        if (!url) continue;
        linkTiles.push({
          type: "link",
          icon: icon || undefined,
          url,
          label: label || url
        });
      }

      let yaml = `profile:
  name: ${escapeYaml(name)}
`;
      if (bio) yaml += `  bio: ${escapeYaml(bio)}
`;
      yaml += `  image: avatar.jpg

theme: ${theme}

tiles:
  - type: heading
    text: Links
`;

      for (const t of linkTiles) {
        yaml += `  - type: link
    url: ${escapeYaml(t.url)}
    label: ${escapeYaml(t.label)}
`;
        if (t.icon) yaml += `    icon: ${t.icon}
`;
      }

      return yaml;
    }

    function addLinkRow(label = "", url = "", icon = "link") {
      const div = document.createElement("div");
      div.className = "link-row";
      div.innerHTML = `
        <input type="text" class="link-label" placeholder="Label" value="${label.replace(/"/g, "&quot;")}">
        <input type="url" class="link-url" placeholder="https://..." value="${url.replace(/"/g, "&quot;")}" required>
        <input type="text" class="link-icon" placeholder="icon" value="${icon.replace(/"/g, "&quot;")}" title="Lucide icon name">
        <button type="button" class="btn btn-secondary remove-link">×</button>
      `;
      div.querySelector(".remove-link").onclick = () => div.remove();
      document.getElementById("links").appendChild(div);
    }

    document.getElementById("addLink").onclick = () => addLinkRow();
    addLinkRow("GitHub", "https://github.com/yourname", "github");
    addLinkRow("Email", "mailto:you@example.com", "mail");

    document.getElementById("form").onsubmit = async (e) => {
      e.preventDefault();
      const btn = document.getElementById("downloadBtn");
      const status = document.getElementById("status");
      btn.disabled = true;
      status.textContent = "Building zip…";
      status.className = "loading";

      try {
        const { default: JSZip } = await import("https://esm.sh/jszip@3.10.1");
        const zip = new JSZip();

        for (const file of FILES) {
          const res = await fetch(baseUrl + file);
          if (!res.ok) throw new Error(`Failed to fetch ${file}: ${res.status}`);
          const blob = await res.blob();
          zip.file(file, blob);
        }

        zip.file("config.yaml", buildConfig());

        const blob = await zip.generateAsync({ type: "blob" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "limn.zip";
        a.click();
        URL.revokeObjectURL(a.href);

        status.textContent = "Download started.";
        status.className = "";
      } catch (err) {
        status.textContent = err.message;
        status.className = "error";
      }
      btn.disabled = false;
    };
  </script>
</body>
</html>
